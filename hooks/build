#!/bin/bash
set -e

[ -z "$IMAGE_NAME" ] && echo "IMAGE_NAME is required" && exit 1;

function imagename {
  buildname=$1
  case $IMAGE_NAME in
    *:latest) echo -n $IMAGE_NAME | sed "s|:latest|:$buildname|" ;;
    *:*) echo -n $IMAGE_NAME | sed "s|:\(.*\)|:\1-$buildname|" ;;
    *) echo $IMAGE_NAME:$buildname ;;
  esac
}

docker build -t $IMAGE_NAME .

CONTEXTS="
java
node
node-kafka
node-kafka-cache
toil
git-init
builder-base
builder-java
builder-node
builder-quarkus
runtime-quarkus
runtime-quarkus-dev
runtime-quarkus-deno
"

# Hack so we can get node-kafka-cache on Node 10.x as well (gracefulfs legacy)
case $IMAGE_NAME in
  *:node10)
    sed -i 's/FROM node:.*/FROM node:10.22.0-buster-slim@sha256:268129dcc7484fe3ba346ff9c5c8f0b467edd44c94205521bd4ace4a729b04c1/' node/Dockerfile
    CONTEXTS="node node-kafka node-kafka-cache"
    ;;
esac

PUSH=""

for CONTEXT in $CONTEXTS; do

  CONTEXT_IMAGE_NAME=$(imagename $CONTEXT)

  docker build -t yolean/$CONTEXT \
    -t yolean/$CONTEXT:$SOURCE_COMMIT \
    -t $CONTEXT_IMAGE_NAME ./$CONTEXT
  PUSH="$PUSH yolean/$CONTEXT:$SOURCE_COMMIT $CONTEXT_IMAGE_NAME"
  if [ "" = "$(docker image inspect -f='{{.Config.User}}' $CONTEXT_IMAGE_NAME)" ]; then
    docker tag $CONTEXT_IMAGE_NAME $CONTEXT_IMAGE_NAME-root
    docker tag yolean/$CONTEXT:$SOURCE_COMMIT yolean/$CONTEXT:$SOURCE_COMMIT-root
    PUSH="$PUSH yolean/$CONTEXT:$SOURCE_COMMIT-root $CONTEXT_IMAGE_NAME-root"
    cat ./$CONTEXT/Dockerfile ./nonroot-footer.Dockerfile | \
      docker build -f - \
      -t yolean/$CONTEXT:$SOURCE_COMMIT \
      -t $CONTEXT_IMAGE_NAME ./$CONTEXT
  fi
done

echo "PUSH list contains: $PUSH"
[ -z "$NOPUSH" ] || exit 0
for P in $PUSH; do docker push $P; done
